---
import MainLayouts from '../layouts/MainLayouts.astro';
import NodeCard from '../components/NodeCard.astro';
import { mqttServers } from '../config/mqtt-servers';

import mqtt from 'mqtt';

// Testdata (H√§r kan du senare h√§mta data fr√•n ett API)
const nodes = [
{ 
    nodeHexId: "!9ea1bb30", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "Hka bb30", 
    powerType: "plug" 
  },
{ 
    nodeHexId: "!6985a080", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "Hka a080", 
    powerType: "plug" 
  },
{ 
    nodeHexId: "!849b96f4", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "RAKLA", 
    powerType: "plug" 
  },
  { 
    nodeHexId: "!9e780860", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "Huskvarna fast punkt 01", 
    powerType: "plug" 
  },
{ 
    nodeHexId: "!lf288732", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "YDRE Nod 01 (RAF)", 
    powerType: "solar" 
  },
{ 
    nodeHexId: "!1c5f55ac", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "Husqvarna Gateway", 
    powerType: "plug" 
  },
{ 
    nodeHexId: "!9e75f9e0", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "Ok√§nd Test router (HIVE-TEST)", 
    powerType: "plug" 
  },
{ 
    nodeHexId: "!e0f604d8", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "Tor zum Kamptal - Router (HIVE-TEST)", 
    powerType: "plug" 
  },

];

---

<MainLayouts title="Nod-√∂versikt | LORA">
  
  <div class="mb-10">
    <h1 class="text-4xl font-black text-yellow-400 mb-2">Driftstatus</h1>
    <p class="text-gray-500 italic">Driftstatus f√∂r Meshtastic-n√§tverket.</p>
  
  <div id="connection-status" class="text-[10px] font-bold text-yellow-400 animate-pulse">
  ANSLUTEN TILL BROKER - V√ÑNTAR P√Ö DATA...
</div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {nodes.map((node) => (
      <NodeCard {...node} />
    ))}
  </div>

<script>
  import mqtt from 'mqtt';
  import type { MqttServer } from '../config/mqtt-servers';
  
  // H√§mta konfigurerade servrar fr√•n config-filen
  const mqttServersConfig = [
    {
      id: 'hivemq',
      name: 'HiveMQ Public Broker',
      brokerUrl: 'wss://broker.hivemq.com:8884/mqtt',
      topic: 'msh/+/+/json/#',
      enabled: true,
    },
    {
      id: 'local',
      name: 'Local Broker',
      brokerUrl: 'wss://localhost:8884/mqtt',
      topic: 'msh/+/+/json/#',
      enabled: false,
    },
    {
      id: 'custom',
      name: 'Custom Broker',
      brokerUrl: 'wss://your-broker.com:8884/mqtt',
      topic: 'msh/+/+/json/#',
      enabled: false,
    },
  ];

  // Sp√•ra anslutningsstatus f√∂r alla servrar
  const connectionStatus: Record<string, boolean> = {};
  const enabledServersCount = mqttServersConfig.filter(s => s.enabled).length;

  // Initiera connectionStatus f√∂r alla servrar (false tills connect s√§tter true)
  mqttServersConfig.forEach(server => {
    connectionStatus[server.id] = false;
  });

  // Funktion f√∂r att ansluta till en broker
  function connectToBroker(server: any) {
    if (!server.enabled) {
      console.log(`${server.name} √§r inaktiverad, hoppar √∂ver...`);
      return;
    }

    const options: any = {
      clientId: `lora_web_${server.id}_${Math.random().toString(16).slice(2, 8)}`,
      clean: true,
      connectTimeout: 4000,
    };
// --- H√ÑR L√ÑGGER DU IN SPECIALKODEN ---
    if (server.id === 'Meshtastic') {
      options.protocolVersion = 4;
      options.path = '/api/v2/mqtt'; 
      console.log("üõ†Ô∏è Applicerar Meshtastic-specifika inst√§llningar...");
    }
    // -------------------------------------
    console.log(`Ansluter till ${server.name}...`);
    const client = mqtt.connect(server.brokerUrl, options);

    client.on('connect', () => {
      connectionStatus[server.id] = true;
      console.log(`‚úÖ Ansluten till ${server.name}!`);
      client.subscribe(server.topic, (err) => {
        if (!err) {
          console.log(`Prenumererar p√• ${server.topic} fr√•n ${server.name}`);
        }
      });
      // Kontrollera och skriv ut status
      printConnectionStatus();
    });

    client.on('message', (topic, message) => {
      handleMqttMessage(message.toString(), server.name);
    });

    client.on('error', (err) => {
      connectionStatus[server.id] = false;
      console.error(`MQTT Connection Error (${server.name}):`, err);
      // F√∂rs√∂ker √•teransluta automatiskt efter 5 sekunder
      setTimeout(() => {
        console.log(`F√∂rs√∂ker √•teransluta till ${server.name}...`);
        connectToBroker(server);
      }, 5000);
    });

    client.on('disconnect', () => {
      connectionStatus[server.id] = false;
      console.log(`Fr√•nkopplad fr√•n ${server.name}`);
    });
  }

  // Funktion f√∂r att skriva ut anslutningsstatus f√∂r alla servrar
  function printConnectionStatus() {
    const enabledServers = mqttServersConfig.filter(s => s.enabled);
    const connectedServers = enabledServers.filter(s => connectionStatus[s.id] === true);
    
    if (connectedServers.length === enabledServersCount) {
      console.clear();
      console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #00FF00; font-weight: bold;');
      console.log('%c‚úÖ ALLA MQTT-SERVRAR ANSLUTNA', 'color: #00FF00; font-weight: bold; font-size: 14px;');
      console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #00FF00; font-weight: bold;');
      
      enabledServers.forEach(server => {
        if (connectionStatus[server.id] === true) {
          console.log(`%c‚úÖ ${server.name}`, 'color: #00FF00; font-weight: bold;');
        }
      });
      
      console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #00FF00; font-weight: bold;');
      updateMqttStatusInNavbar(true);
    }
  }

  function updateMqttStatusInNavbar(isConnected: boolean) {
    const statusEl = document.getElementById('mqtt-status-text');
    if (statusEl) {
      if (isConnected) {
        statusEl.innerText = '‚úÖ Aktiva MQTT servrar √§r anslutna';
        statusEl.className = 'text-green-300 font-bold';
      } else {
        statusEl.innerText = 'V√§ntar p√• anslutning';
        statusEl.className = 'text-yellow-300 font-bold';
      }
    }
  }

  // Funktion f√∂r att hantera inkommande MQTT-meddelanden
  function handleMqttMessage(message: string, source: string) {
    try {
      const data = JSON.parse(message);
      const hexId = '!' + data.from.toString(16).toLowerCase();
      const card = document.getElementById(`node-${hexId}`);

      if (card) {
        // D√∂lj "v√§ntar"-skylten n√§r f√∂rsta matchen hittas
        const statusEl = document.getElementById('connection-status');
        if (statusEl) statusEl.style.display = 'none';

        // Uppdatera BATTERI
        if (data.payload?.battery_level !== undefined) {
          const batEl = card.querySelector('.node-battery') as HTMLElement;
          if (batEl) {
            batEl.innerText = data.payload.battery_level + '%';
            // √Ñndra f√§rg dynamiskt
            if (data.payload.battery_level < 20) {
              batEl.className = 'node-battery text-lg font-bold text-red-500';
            } else if (data.payload.battery_level < 50) {
              batEl.className = 'node-battery text-lg font-bold text-yellow-600';
            } else {
              batEl.className = 'node-battery text-lg font-bold text-green-600';
            }
          }
        }

        // Uppdatera SP√ÑNNING
        if (data.payload?.voltage !== undefined) {
          const voltEl = card.querySelector('.node-voltage') as HTMLElement;
          if (voltEl) voltEl.innerText = data.payload.voltage.toFixed(2) + 'v';
        }

        // Uppdatera H√ÖRDVARA
        if (data.payload?.model) {
          const hwEl = card.querySelector('.node-hw') as HTMLElement;
          if (hwEl) hwEl.innerText = data.payload.model.replace(/_/g, ' ');
        }

        // Uppdatera POSITION om den finns i meddelandet
        try {
          const lat = data.payload?.position?.latitude ?? data.payload?.position?.lat ?? data.payload?.gps?.lat ?? data.payload?.gps?.latitude ?? data.payload?.lat ?? data.lat;
          const lon = data.payload?.position?.longitude ?? data.payload?.position?.lon ?? data.payload?.gps?.lon ?? data.payload?.gps?.longitude ?? data.payload?.lon ?? data.lon;
          if (lat !== undefined && lat !== null && lon !== undefined && lon !== null) {
            const latNum = parseFloat(lat);
            const lonNum = parseFloat(lon);
            // Verifiera att parseFloat gav giltiga v√§rden
            if (!isNaN(latNum) && !isNaN(lonNum)) {
              const posEl = card.querySelector('.node-position') as HTMLElement;
              const wrapper = card.querySelector('.node-position-wrapper');
              if (posEl) {
                posEl.innerText = `${latNum.toFixed(6)}, ${lonNum.toFixed(6)}`;
              }
              if (wrapper) {
                wrapper.classList.remove('hidden');
                const mapLink = wrapper.querySelector('a') as HTMLAnchorElement;
                if (mapLink) {
                  mapLink.href = `https://www.google.com/maps?q=${latNum},${lonNum}`;
                }
              }
              console.log(`üìç Position uppdaterad f√∂r ${hexId}: ${latNum.toFixed(6)}, ${lonNum.toFixed(6)}`);
            }
          }
        } catch (e) {
          console.warn(`Position parsing error f√∂r ${hexId}:`, e);
        }

        // Uppdatera TID
        const timeEl = card.querySelector('.node-lastseen') as HTMLElement;
        if (timeEl) timeEl.innerText = new Date().toLocaleTimeString();

        // Uppdatera K√ÑLLA (visa endast n√§r data fr√•n k√§lla kommer)
        const sourceEl = card.querySelector('.node-source') as HTMLElement;
        const sourceWrapper = card.querySelector('.node-source-wrapper');
        if (sourceEl) {
          sourceEl.innerText = source;
        }
        if (sourceWrapper) {
          sourceWrapper.classList.remove('hidden');
        }

        // Visuell feedback (Blinka till)
        card.classList.add('border-blue-400', 'scale-[1.02]');
        setTimeout(() => card.classList.remove('border-blue-400', 'scale-[1.02]'), 500);

        // Spara data till localStorage
        try {
          const nodeData = {
            nodeHexId: hexId,
            battery: data.payload?.battery_level ?? null,
            voltage: data.payload?.voltage ?? null,
            hardware: data.payload?.model ?? null,
            channelUtil: data.payload?.channel_util_percent ?? null,
            airUtil: data.payload?.air_util_tx ?? null,
            latitude: null as number | null,
            longitude: null as number | null,
            source: source,
            lastUpdate: new Date().toISOString(),
          };

          // Spara position om den finns
          const lat = data.payload?.position?.latitude ?? data.payload?.position?.lat ?? data.payload?.gps?.lat ?? data.payload?.gps?.latitude ?? data.payload?.lat ?? data.lat;
          const lon = data.payload?.position?.longitude ?? data.payload?.position?.lon ?? data.payload?.gps?.lon ?? data.payload?.gps?.longitude ?? data.payload?.lon ?? data.lon;
          if (lat !== undefined && lat !== null && lon !== undefined && lon !== null) {
            nodeData.latitude = parseFloat(lat);
            nodeData.longitude = parseFloat(lon);
          }

          localStorage.setItem(`node-${hexId}`, JSON.stringify(nodeData));
          console.log(`üíæ Data sparad f√∂r ${hexId} i localStorage`);
        } catch (e) {
          console.warn(`Kunde inte spara data f√∂r ${hexId} i localStorage:`, e);
        }
      }
    } catch (e) {
      console.error('Kunde inte tolka paket:', e);
    }
  }

  // Anslut till alla aktiverade brokers
  mqttServersConfig.forEach(server => {
    connectToBroker(server);
  });
</script>

</MainLayouts>