---
import MainLayouts from '../layouts/MainLayouts.astro';
import NodeCard from '../components/NodeCard.astro';

import mqtt from 'mqtt';



// Testdata (Här kan du senare hämta data från ett API)
const nodes = [
{ 
    nodeHexId: "!9ea1bb30", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "Hka bb30", 
    powerType: "plug" 
  },
{ 
    nodeHexId: "!6985a080", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "Hka a080", 
    powerType: "plug" 
  },
{ 
    nodeHexId: "!849b96f4", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "RAKLA", 
    powerType: "plug" 
  },
  { 
    nodeHexId: "!9e780860", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "Huskvarna fast punkt 01", 
    powerType: "plug" 
  },
{ 
    nodeHexId: "!lf288732", // Detta ID hittar du i Meshtastic-appen (t.ex. !f4a2)
    name: "YDRE Nod 01 (RAF)", 
    powerType: "solar" 
  },

];

---

<MainLayouts title="Nod-översikt | LORA">
  
  <div class="mb-10">
    <h1 class="text-4xl font-black text-yellow-400 mb-2">Driftstatus</h1>
    <p class="text-gray-500 italic">Driftstatus för Meshtastic-nätverket.</p>
  
  <div id="connection-status" class="text-[10px] font-bold text-yellow-400 animate-pulse">
  ANSLUTEN TILL BROKER - VÄNTAR PÅ DATA...
</div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {nodes.map((node) => (
      <NodeCard {...node} />
    ))}
  </div>

<script>
  import mqtt from 'mqtt';

 


  // 1. Inställningar för liamcottle
  // Vi använder wss (Websocket Secure) på port 8084
  const brokerUrl = 'wss://broker.emqx.io:8084/mqtt';
  
  const options = {
    clientId: 'lora_web_' + Math.random().toString(16).slice(2, 8),
    clean: true,
    connectTimeout: 4000,
  };

  console.log('Ansluter till Emqx-Broker...');
  const client = mqtt.connect(brokerUrl, options);

  // 2. Vid anslutning - börja prenumerera
  client.on('connect', () => {
    console.log('✅ Ansluten till MQTT Broker!');
    // Här sätter du din topic. 
    // Om du använder Meshtastic standard JSON, ändra till din topic:
    client.subscribe('msh/EU_868/2/json/LongFast/#', (err) => {
      if (!err) {
        console.log('Prenumererar på Meshtastic JSON-data');
      }
    });
  });

  // När ett meddelande landar in släcks "väntar på data" skylten
client.on('message', () => {
  document.getElementById('connection-status').style.display = 'none';
});

  // 3. När ett meddelande landar
  client.on('message', (topic, message) => {
    try {
      const data = JSON.parse(message.toString());
      console.log('Ny data mottagen:', data);

      // Meshtastic skickar ofta 'from' som ett decimalt tal. 
      // Vi gör om det till Hex och lägger till '!' för att matcha Meshtastic-standard
      const hexId = '!' + data.from.toString(16).toLowerCase();
      
      // Hitta rätt box i HTML-koden
      const card = document.getElementById(`node-${hexId}`);

      if (card) {
        // Uppdatera Batteri om det finns i paketet
        if (data.payload?.battery_level !== undefined) {
          const batteryEl = card.querySelector('.node-battery');
          if (batteryEl) batteryEl.innerText = data.payload.battery_level + '%';
        }

        // Uppdatera Spänning (Voltage)
        if (data.payload?.voltage !== undefined) {
          const voltageEl = card.querySelector('.node-voltage');
          if (voltageEl) voltageEl.innerText = data.payload.voltage.toFixed(2) + 'v';
        }

        // Uppdatera tidsstämpel
        const timeEl = card.querySelector('.node-lastseen');
        if (timeEl) timeEl.innerText = new Date().toLocaleTimeString();

        // En liten visuell "blixt" för att visa att data kom in
        card.classList.add('border-blue-400');
        setTimeout(() => card.classList.remove('border-blue-400'), 1000);
      }
    } catch (e) {
      console.error('Kunde inte tolka JSON-data', e);
    }
  });

  client.on('error', (err) => {
    console.error('MQTT Connection Error: ', err);
    client.end();
  });
</script>

</MainLayouts>